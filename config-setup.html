<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    update
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // Load saved config
  let savedConfig;
  try {
    savedConfig = JSON.parse(localStorage.getItem("firebaseConfig") || "{}");
  } catch {
    savedConfig = {};
  }
  const isLocked = localStorage.getItem("firebaseConfigLocked") === "true";

  if (!savedConfig.apiKey) {
    document.getElementById("configFormContainer").classList.remove("hidden");
  } else {
    try {
      const app = initializeApp(savedConfig);
      const auth = getAuth();
      const db = getDatabase();

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        const uid = user.uid;
        const userRef = ref(db, `students/${uid}`);
        get(userRef).then((snap) => {
          const userData = snap.val() || {};
          const role = userData.role || "student";
          const configDone = userData.configCompleted === true;

          if (role !== "buyer") {
            window.location.href = "home.html";
          } else if (configDone || isLocked) {
            window.location.href = "dashboard.html";
          } else {
            document.getElementById("configFormContainer").classList.remove("hidden");
          }
        });
      });
    } catch (err) {
      alert("❌ Invalid config. Please re-enter.");
      localStorage.clear();
      location.reload();
    }
  }

  // Save Config
  async function saveConfig() {
    const config = {
      apiKey: document.getElementById("apiKey").value.trim(),
      authDomain: document.getElementById("authDomain").value.trim(),
      projectId: document.getElementById("projectId").value.trim(),
      storageBucket: document.getElementById("storageBucket").value.trim(),
      messagingSenderId: document.getElementById("messagingSenderId").value.trim(),
      appId: document.getElementById("appId").value.trim(),
      databaseURL: document.getElementById("databaseURL").value.trim().replace(/^"+|"+$/g, ""),
    };

    if (Object.values(config).some((val) => val === "")) {
      alert("Please fill in all fields.");
      return;
    }

    try {
      localStorage.setItem("firebaseConfig", JSON.stringify(config));
      localStorage.setItem("firebaseConfigLocked", "true");

      const app = initializeApp(config);
      const auth = getAuth();
      const db = getDatabase();
      const user = auth.currentUser;

      if (user) {
        const uid = user.uid;
        await update(ref(db, `students/${uid}`), { configCompleted: true });
      }

      alert("✅ Config saved!");
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 150);
    } catch (err) {
      alert("❌ Could not save config. Try again in a different browser or hosting environment.");
    }
  }

  // Reset Config
  function resetConfig() {
    localStorage.removeItem("firebaseConfig");
    localStorage.removeItem("firebaseConfigLocked");
    alert("Firebase config has been cleared.");
    location.reload();
  }

  window.saveConfig = saveConfig;
  window.resetConfig = resetConfig;
</script>

